import os
import re
import chardet
from typing import List, Dict

# üîß –ù–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è
COMPANY_NAME = "ALCHIN"

# üîß –ù–æ–º–µ—Ä–∞ –Ω–∞—à–∏—Ö —Å—á–µ—Ç–æ–≤ (–ò–ò–ö)
OUR_ACCOUNTS = [
    "KZ87722C000022014099",  # Kaspi Bank
    "KZ88722S000040014444",  # Kaspi Pay
    # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–æ–≤ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
]

# üîß –ö–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å
FIELDS = [
    "–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    "–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    "–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ë–ò–ù_–ò–ò–ù",
    "–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ë–ò–ù_–ò–ò–ù",
    "–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ò–ò–ö",
    "–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ò–ò–ö",
    "–ù–æ–º–µ—Ä–î–æ–∫—É–º–µ–Ω—Ç–∞",
    "–î–∞—Ç–∞–û–ø–µ—Ä–∞—Ü–∏–∏",
    "–°—É–º–º–∞–†–∞—Å—Ö–æ–¥",
    "–°—É–º–º–∞–ü—Ä–∏—Ö–æ–¥",
    "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–ü–ª–∞—Ç–µ–∂–∞"
]


def detect_encoding(filepath: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ñ–∞–π–ª–∞"""
    with open(filepath, "rb") as f:
        raw = f.read(2048)
    result = chardet.detect(raw)
    return result["encoding"] or "utf-8"


def determine_transaction_type(payer_iik: str, receiver_iik: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ò–ò–ö –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    
    Args:
        payer_iik: –ò–ò–ö –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
        receiver_iik: –ò–ò–ö –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    
    Returns:
        'transfer' - –µ—Å–ª–∏ –æ–±–∞ –ò–ò–ö –Ω–∞—à–∏ —Å—á–µ—Ç–∞
        'expense' - –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ –Ω–∞—à —Å—á–µ—Ç
        'income' - –µ—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–∞—à —Å—á–µ—Ç
        'unknown' - –µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –ò–ò–ö –Ω–µ –Ω–∞—à
    """
    payer_is_ours = payer_iik in OUR_ACCOUNTS
    receiver_is_ours = receiver_iik in OUR_ACCOUNTS
    
    if payer_is_ours and receiver_is_ours:
        return 'transfer'  # –ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –Ω–∞—à–∏–º–∏ —Å—á–µ—Ç–∞–º–∏
    elif payer_is_ours:
        return 'expense'   # –ú—ã –ø–ª–∞—Ç–∏–º (—Ä–∞—Å—Ö–æ–¥)
    elif receiver_is_ours:
        return 'income'    # –ù–∞–º –ø–ª–∞—Ç—è—Ç (–¥–æ—Ö–æ–¥)
    else:
        return 'unknown'   # –ù–µ –Ω–∞—à–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è


def parse_1c_files(file_paths: List[str]) -> List[Dict[str, str]]:
    """
    –ü–∞—Ä—Å–∏—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞ 1CClientBankExchange
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ –∏–∑ FIELDS
    """
    all_records = []

    for file_path in file_paths:
        encoding = detect_encoding(file_path)
        with open(file_path, "r", encoding=encoding, errors="ignore") as f:
            text = f.read()

        # –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∫–ª—é—á–µ–π
        text = re.sub(r'([–ê-–ØA-Z_]+)=', lambda m: m.group(1).capitalize() + '=', text)

        # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –±–ª–æ–∫–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        docs = re.split(r"–°–µ–∫—Ü–∏—è–î–æ–∫—É–º–µ–Ω—Ç=.*?\n", text, flags=re.IGNORECASE)

        for doc in docs:
            record = {}

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –±–ª–æ–∫–∏
            if not doc.strip():
                continue

            # –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∫–ª—é—á–∏
            for field in FIELDS + ["–°—É–º–º–∞"]:
                # –ù–∞–π–¥—ë–º "–ö–ª—é—á=–ó–Ω–∞—á–µ–Ω–∏–µ"
                match = re.search(rf"{field}\s*=\s*(.+)", doc, flags=re.IGNORECASE)
                if match:
                    record[field] = match.group(1).strip()

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã (–∑–Ω–∞—á–∏—Ç –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç)
            if "–î–∞—Ç–∞–û–ø–µ—Ä–∞—Ü–∏–∏" not in record:
                continue

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ "–°—É–º–º–∞=", –∞ –Ω–µ—Ç –°—É–º–º–∞–†–∞—Å—Ö–æ–¥/–°—É–º–º–∞–ü—Ä–∏—Ö–æ–¥ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π)
            if "–°—É–º–º–∞" in record and ("–°—É–º–º–∞–†–∞—Å—Ö–æ–¥" in record or "–°—É–º–º–∞–ü—Ä–∏—Ö–æ–¥" in record):
                record.pop("–°—É–º–º–∞", None)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ò–ò–ö
            payer_iik = record.get("–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ò–ò–ö", "").strip()
            receiver_iik = record.get("–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ò–ò–ö", "").strip()
            
            transaction_type = determine_transaction_type(payer_iik, receiver_iik)
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –Ω–∞—à–∏–º —Å—á–µ—Ç–∞–º
            if transaction_type == 'unknown':
                continue
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –∑–∞–ø–∏—Å—å
            record["–¢–∏–ø–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"] = transaction_type
            
            # –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if transaction_type == 'transfer':
                record["–°—á–µ—Ç–û—Ç–∫—É–¥–∞"] = payer_iik
                record["–°—á–µ—Ç–ö—É–¥–∞"] = receiver_iik
                record["–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"] = "–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏"
            elif transaction_type == 'income':
                record["–°—á–µ—Ç"] = receiver_iik
                record["–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"] = record.get("–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "")
            elif transaction_type == 'expense':
                record["–°—á–µ—Ç"] = payer_iik
                record["–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"] = record.get("–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "")

            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
            all_records.append({k: record.get(k, "") for k in FIELDS + ["–¢–∏–ø–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", "–°—á–µ—Ç–û—Ç–∫—É–¥–∞", "–°—á–µ—Ç–ö—É–¥–∞", "–°—á–µ—Ç", "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"]})

    return all_records


# ‚úÖ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Ñ–∞–π–ª–∞–º–∏
    folder = "."
    files = [os.path.join(folder, f) for f in os.listdir(folder) if f.endswith(".txt")]

    records = parse_1c_files(files)

    # –í—ã–≤–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    print(f"–ù–∞–π–¥–µ–Ω–æ {len(records)} –æ–ø–µ—Ä–∞—Ü–∏–π:")
    for r in records[:5]:
        print(f"–¢–∏–ø: {r.get('–¢–∏–ø–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        print(f"–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {r.get('–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        if r.get('–¢–∏–ø–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏') == 'transfer':
            print(f"–ü–µ—Ä–µ–≤–æ–¥: {r.get('–°—á–µ—Ç–û—Ç–∫—É–¥–∞', '')} ‚Üí {r.get('–°—á–µ—Ç–ö—É–¥–∞', '')}")
        else:
            print(f"–°—á–µ—Ç: {r.get('–°—á–µ—Ç', '')}")
        print(f"–°—É–º–º–∞: {r.get('–°—É–º–º–∞–†–∞—Å—Ö–æ–¥', r.get('–°—É–º–º–∞–ü—Ä–∏—Ö–æ–¥', ''))}")
        print("---")

    # –ü—Ä–∏–º–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –≤—Å—Ç–∞–≤–∫–µ –≤ –ë–î:
    # cursor.executemany(
    #     """INSERT INTO payments (
    #         receiver_name, payer_name, payer_bin, receiver_bin,
    #         operation_date, expense_sum, income_sum, payment_purpose
    #     ) VALUES (%(–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ)s, %(–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ)s, %(–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ë–ò–ù_–ò–ò–ù)s,
    #               %(–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ë–ò–ù_–ò–ò–ù)s, %(–î–∞—Ç–∞–û–ø–µ—Ä–∞—Ü–∏–∏)s, %(–°—É–º–º–∞–†–∞—Å—Ö–æ–¥)s,
    #               %(–°—É–º–º–∞–ü—Ä–∏—Ö–æ–¥)s, %(–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–ü–ª–∞—Ç–µ–∂–∞)s)""",
    #     records
    # )
